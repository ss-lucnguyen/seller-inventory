@page "/categories"
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Categories - SellerInventer</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Categories</h2>
        <DxButton Text="Add Category" IconCssClass="oi oi-plus" RenderStyle="ButtonRenderStyle.Primary" Click="ShowAddModal" />
    </div>

    <DxGrid Data="_categories"
            ShowFilterRow="true"
            ShowSearchBox="true"
            PageSize="10"
            PagerVisible="true"
            CssClass="w-100">
        <Columns>
            <DxGridDataColumn FieldName="Name" Caption="Name" />
            <DxGridDataColumn FieldName="Description" Caption="Description" />
            <DxGridDataColumn FieldName="IsActive" Caption="Status">
                <CellDisplayTemplate>
                    @{
                        var isActive = (bool)context.Value;
                        <span class="badge @(isActive ? "bg-success" : "bg-danger")">
                            @(isActive ? "Active" : "Inactive")
                        </span>
                    }
                </CellDisplayTemplate>
            </DxGridDataColumn>
            <DxGridDataColumn Caption="Actions" Width="180px">
                <CellDisplayTemplate>
                    @{
                        var category = (CategoryResponse)context.DataItem;
                        <DxButton Text="Edit" RenderStyle="ButtonRenderStyle.Secondary" SizeMode="SizeMode.Small" Click="() => ShowEditModal(category)" CssClass="me-1" />
                        <DxButton Text="Delete" RenderStyle="ButtonRenderStyle.Danger" SizeMode="SizeMode.Small" Click="() => DeleteCategory(category.Id)" />
                    }
                </CellDisplayTemplate>
            </DxGridDataColumn>
        </Columns>
    </DxGrid>
</div>

<DxPopup @bind-Visible="_showModal"
         HeaderText="@(_isEditing ? "Edit Category" : "Add Category")"
         Width="400px"
         CloseOnOutsideClick="false"
         ShowCloseButton="true">
    <BodyContentTemplate Context="popupContext">
        <EditForm Model="_formModel" OnValidSubmit="SaveCategory" Context="editContext">
            <DataAnnotationsValidator />
            <DxFormLayout>
                <DxFormLayoutItem Caption="Name" ColSpanMd="12">
                    <DxTextBox @bind-Text="_formModel.Name" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                    <DxMemo @bind-Text="_formModel.Description" Rows="3" />
                </DxFormLayoutItem>
                @if (_isEditing)
                {
                    <DxFormLayoutItem Caption="Active" ColSpanMd="12">
                        <DxCheckBox @bind-Checked="_formModel.IsActive" />
                    </DxFormLayoutItem>
                }
            </DxFormLayout>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <DxButton Text="Cancel" RenderStyle="ButtonRenderStyle.Secondary" Click="CloseModal" />
                <DxButton Text="Save" RenderStyle="ButtonRenderStyle.Primary" SubmitFormOnClick="true" />
            </div>
        </EditForm>
    </BodyContentTemplate>
</DxPopup>

@code {
    [Inject] private ICategoryService CategoryService { get; set; } = default!;

    private IReadOnlyList<CategoryResponse> _categories = new List<CategoryResponse>();
    private bool _showModal;
    private bool _isEditing;
    private Guid? _editingId;
    private CategoryFormModel _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _categories = await CategoryService.GetAllAsync();
    }

    private void ShowAddModal()
    {
        _formModel = new CategoryFormModel();
        _isEditing = false;
        _editingId = null;
        _showModal = true;
    }

    private void ShowEditModal(CategoryResponse category)
    {
        _formModel = new CategoryFormModel
        {
            Name = category.Name,
            Description = category.Description,
            IsActive = category.IsActive
        };
        _isEditing = true;
        _editingId = category.Id;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private async Task SaveCategory()
    {
        if (_isEditing && _editingId.HasValue)
        {
            var request = new UpdateCategoryRequest(_formModel.Name, _formModel.Description, _formModel.IsActive);
            await CategoryService.UpdateAsync(_editingId.Value, request);
        }
        else
        {
            var request = new CreateCategoryRequest(_formModel.Name, _formModel.Description);
            await CategoryService.CreateAsync(request);
        }

        _showModal = false;
        await LoadData();
    }

    private async Task DeleteCategory(Guid id)
    {
        await CategoryService.DeleteAsync(id);
        await LoadData();
    }

    private class CategoryFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
