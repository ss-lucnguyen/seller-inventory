@page "/products"
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Products - SellerInventer</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Products</h2>
        <DxButton Text="Add Product" IconCssClass="oi oi-plus" RenderStyle="ButtonRenderStyle.Primary" Click="ShowAddModal" />
    </div>

    <DxGrid Data="_products"
            ShowFilterRow="true"
            ShowSearchBox="true"
            PageSize="10"
            PagerVisible="true"
            CssClass="w-100">
        <Columns>
            <DxGridDataColumn FieldName="Name" Caption="Name" />
            <DxGridDataColumn FieldName="SKU" Caption="SKU" />
            <DxGridDataColumn FieldName="CategoryName" Caption="Category" />
            <DxGridDataColumn FieldName="CostPrice" Caption="Cost Price" DisplayFormat="c2" />
            <DxGridDataColumn FieldName="SellPrice" Caption="Sell Price" DisplayFormat="c2" />
            <DxGridDataColumn FieldName="StockQuantity" Caption="Stock" />
            <DxGridDataColumn FieldName="IsActive" Caption="Status">
                <CellDisplayTemplate>
                    @{
                        var isActive = (bool)context.Value;
                        <span class="badge @(isActive ? "bg-success" : "bg-danger")">
                            @(isActive ? "Active" : "Inactive")
                        </span>
                    }
                </CellDisplayTemplate>
            </DxGridDataColumn>
            <DxGridDataColumn Caption="Actions" Width="200px">
                <CellDisplayTemplate>
                    @{
                        var product = (ProductResponse)context.DataItem;
                        <DxButton Text="Edit" RenderStyle="ButtonRenderStyle.Secondary" SizeMode="SizeMode.Small" Click="() => ShowEditModal(product)" CssClass="me-1" />
                        <DxButton Text="Delete" RenderStyle="ButtonRenderStyle.Danger" SizeMode="SizeMode.Small" Click="() => DeleteProduct(product.Id)" />
                    }
                </CellDisplayTemplate>
            </DxGridDataColumn>
        </Columns>
    </DxGrid>
</div>

<DxPopup @bind-Visible="_showModal"
         HeaderText="@(_isEditing ? "Edit Product" : "Add Product")"
         Width="500px"
         CloseOnOutsideClick="false"
         ShowCloseButton="true">
    <BodyContentTemplate Context="popupContext">
        <EditForm Model="_formModel" OnValidSubmit="SaveProduct" Context="editContext">
            <DataAnnotationsValidator />
            <DxFormLayout>
                <DxFormLayoutItem Caption="Name" ColSpanMd="12">
                    <DxTextBox @bind-Text="_formModel.Name" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Description" ColSpanMd="12">
                    <DxMemo @bind-Text="_formModel.Description" Rows="3" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="SKU" ColSpanMd="12">
                    <DxTextBox @bind-Text="_formModel.SKU" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Category" ColSpanMd="12">
                    <DxComboBox Data="_categories"
                                TextFieldName="Name"
                                ValueFieldName="Id"
                                @bind-Value="_formModel.CategoryId"
                                NullText="Select Category" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Cost Price" ColSpanMd="6">
                    <DxSpinEdit @bind-Value="_formModel.CostPrice" MinValue="0" Increment="0.01m" DisplayFormat="c2" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Sell Price" ColSpanMd="6">
                    <DxSpinEdit @bind-Value="_formModel.SellPrice" MinValue="0" Increment="0.01m" DisplayFormat="c2" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Stock Quantity" ColSpanMd="12">
                    <DxSpinEdit @bind-Value="_formModel.StockQuantity" MinValue="0" />
                </DxFormLayoutItem>
                @if (_isEditing)
                {
                    <DxFormLayoutItem Caption="Active" ColSpanMd="12">
                        <DxCheckBox @bind-Checked="_formModel.IsActive" />
                    </DxFormLayoutItem>
                }
            </DxFormLayout>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <DxButton Text="Cancel" RenderStyle="ButtonRenderStyle.Secondary" Click="CloseModal" />
                <DxButton Text="Save" RenderStyle="ButtonRenderStyle.Primary" SubmitFormOnClick="true" />
            </div>
        </EditForm>
    </BodyContentTemplate>
</DxPopup>

@code {
    [Inject] private IProductService ProductService { get; set; } = default!;
    [Inject] private ICategoryService CategoryService { get; set; } = default!;

    private IReadOnlyList<ProductResponse> _products = new List<ProductResponse>();
    private IReadOnlyList<CategoryResponse> _categories = new List<CategoryResponse>();
    private bool _showModal;
    private bool _isEditing;
    private Guid? _editingId;
    private ProductFormModel _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _products = await ProductService.GetAllAsync();
        _categories = await CategoryService.GetAllAsync();
    }

    private void ShowAddModal()
    {
        _formModel = new ProductFormModel();
        _isEditing = false;
        _editingId = null;
        _showModal = true;
    }

    private void ShowEditModal(ProductResponse product)
    {
        _formModel = new ProductFormModel
        {
            Name = product.Name,
            Description = product.Description,
            SKU = product.SKU,
            CostPrice = product.CostPrice,
            SellPrice = product.SellPrice,
            StockQuantity = product.StockQuantity,
            CategoryId = product.CategoryId,
            IsActive = product.IsActive
        };
        _isEditing = true;
        _editingId = product.Id;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private async Task SaveProduct()
    {
        if (_isEditing && _editingId.HasValue)
        {
            var request = new UpdateProductRequest(
                _formModel.Name,
                _formModel.Description,
                _formModel.SKU,
                _formModel.CostPrice,
                _formModel.SellPrice,
                _formModel.StockQuantity,
                _formModel.CategoryId,
                _formModel.IsActive
            );
            await ProductService.UpdateAsync(_editingId.Value, request);
        }
        else
        {
            var request = new CreateProductRequest(
                _formModel.Name,
                _formModel.Description,
                _formModel.SKU,
                _formModel.CostPrice,
                _formModel.SellPrice,
                _formModel.StockQuantity,
                _formModel.CategoryId
            );
            await ProductService.CreateAsync(request);
        }

        _showModal = false;
        await LoadData();
    }

    private async Task DeleteProduct(Guid id)
    {
        await ProductService.DeleteAsync(id);
        await LoadData();
    }

    private class ProductFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? SKU { get; set; }
        public decimal CostPrice { get; set; }
        public decimal SellPrice { get; set; }
        public int StockQuantity { get; set; }
        public Guid CategoryId { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
