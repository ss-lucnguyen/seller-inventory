@page "/pos"
@attribute [Authorize]
@implements IDisposable

<PageTitle>POS - SellerInventer</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["PointOfSale"]</MudText>

<MudGrid Spacing="3">
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2" Class="pa-0" Style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
            <div class="pa-4 d-flex justify-space-between align-center" style="border-bottom: 1px solid #eee;">
                <MudText Typo="Typo.h6">@L["Products"]</MudText>
                <MudSelect T="Guid?" Value="_selectedCategoryId" ValueChanged="OnCategoryChanged"
                           Placeholder="@L["AllCategories"]" Clearable="true" Style="width: 200px;"
                           Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense">
                    @foreach (var category in _categories)
                    {
                        <MudSelectItem Value="@((Guid?)category.Id)">@category.Name</MudSelectItem>
                    }
                </MudSelect>
            </div>

            <div class="pa-4" style="flex: 1; overflow-y: auto;">
                <MudGrid Spacing="2">
                    @foreach (var product in _filteredProducts.Where(p => p.IsActive && p.StockQuantity > 0))
                    {
                        <MudItem xs="6" sm="4" lg="3">
                            <MudCard Elevation="2" Style="cursor: pointer; transition: all 0.2s;" Class="product-card" @onclick="() => AddToCart(product)">
                                <MudCardContent Class="text-center pa-3">
                                    <MudAvatar Color="Color.Primary" Size="Size.Large" Variant="Variant.Filled" Class="mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                                    </MudAvatar>
                                    <MudText Typo="Typo.subtitle2" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        @product.Name
                                    </MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">
                                        @Lang.FormatCurrency(product.SellPrice)
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(product.StockQuantity < 10 ? Color.Warning : Color.Success)">
                                        @product.StockQuantity @L["InStock"]
                                    </MudChip>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }

                    @if (!_filteredProducts.Any(p => p.IsActive && p.StockQuantity > 0))
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Class="text-center">
                                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" />
                                <MudText Class="mt-2">@L["NoProducts"]</MudText>
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-0" Style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
            <div class="pa-4 d-flex justify-space-between align-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" Style="vertical-align: middle;" />
                    @L["ShoppingCart"]
                </MudText>
                @if (_cartItems.Any())
                {
                    <MudChip T="string" Size="Size.Small" Style="background: white; color: #667eea; font-weight: 600;">@_cartItems.Sum(i => i.Quantity) @L["Items"]</MudChip>
                }
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                @if (_cartItems.Any())
                {
                    @foreach (var item in _cartItems)
                    {
                        <MudPaper Class="pa-3 mb-2" Elevation="0" Style="background: #f5f5f5;">
                            <div class="d-flex justify-space-between mb-2">
                                <MudText Typo="Typo.subtitle2">@item.ProductName</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@Lang.FormatCurrency(item.UnitPrice)</MudText>
                            </div>
                            <div class="d-flex justify-space-between align-center">
                                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                    <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => UpdateQuantity(item, -1)" />
                                    <MudButton Disabled="true">@item.Quantity</MudButton>
                                    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => UpdateQuantity(item, 1)" />
                                </MudButtonGroup>
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-weight: 700;">
                                    @Lang.FormatCurrency(item.UnitPrice * item.Quantity)
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => RemoveFromCart(item)" />
                            </div>
                        </MudPaper>
                    }
                }
                else
                {
                    <div class="text-center pa-8" style="color: #999;">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" Style="opacity: 0.3;" />
                        <MudText Class="mt-2">@L["CartEmpty"]</MudText>
                        <MudText Typo="Typo.caption">@L["ClickProducts"]</MudText>
                    </div>
                }
            </div>

            @if (_cartItems.Any())
            {
                <div class="pa-4" style="border-top: 1px solid #eee; background: #fafafa;">
                    <div class="d-flex justify-space-between mb-1">
                        <MudText Color="Color.Secondary">@L["Subtotal"]</MudText>
                        <MudText>@Lang.FormatCurrency(_subtotal)</MudText>
                    </div>
                    <div class="d-flex justify-space-between mb-2">
                        <MudText Color="Color.Secondary">@L["Tax"]</MudText>
                        <MudText>@Lang.FormatCurrency(_tax)</MudText>
                    </div>
                    <MudDivider Class="my-2" />
                    <div class="d-flex justify-space-between mb-3">
                        <MudText Typo="Typo.h6">@L["Total"]</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">@Lang.FormatCurrency(_total)</MudText>
                    </div>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Large"
                               Disabled="_isProcessing" OnClick="ProcessOrder"
                               StartIcon="@Icons.Material.Filled.Payment">
                        @(_isProcessing ? L["Processing"] : L["CompleteOrder"])
                    </MudButton>
                </div>
            }

            @if (!string.IsNullOrEmpty(_message))
            {
                <MudAlert Severity="@(_isSuccess ? Severity.Success : Severity.Error)" Class="ma-2" Dense="true">
                    @_message
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<style>
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }
</style>

@code {
    [Inject] private IProductService ProductService { get; set; } = default!;
    [Inject] private ICategoryService CategoryService { get; set; } = default!;
    [Inject] private IOrderService OrderService { get; set; } = default!;
    [Inject] private ILanguageService Lang { get; set; } = default!;
    [Inject] private ILocalizationService L { get; set; } = default!;

    private IReadOnlyList<ProductResponse> _products = new List<ProductResponse>();
    private IReadOnlyList<ProductResponse> _filteredProducts = new List<ProductResponse>();
    private IReadOnlyList<CategoryResponse> _categories = new List<CategoryResponse>();
    private List<CartItem> _cartItems = new();
    private Guid? _selectedCategoryId;
    private decimal _subtotal;
    private decimal _tax;
    private decimal _total;
    private bool _isProcessing;
    private string? _message;
    private bool _isSuccess;

    protected override async Task OnInitializedAsync()
    {
        Lang.OnLanguageChanged += OnLanguageChanged;
        _products = await ProductService.GetAllAsync();
        _categories = await CategoryService.GetAllAsync();
        _filteredProducts = _products;
    }

    private void OnCategoryChanged(Guid? categoryId)
    {
        _selectedCategoryId = categoryId;
        _filteredProducts = categoryId.HasValue
            ? _products.Where(p => p.CategoryId == categoryId).ToList()
            : _products;
    }

    private void AddToCart(ProductResponse product)
    {
        _message = null;
        var existingItem = _cartItems.FirstOrDefault(i => i.ProductId == product.Id);
        if (existingItem is not null)
        {
            if (existingItem.Quantity < product.StockQuantity)
            {
                existingItem.Quantity++;
            }
        }
        else
        {
            _cartItems.Add(new CartItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                UnitPrice = product.SellPrice,
                Quantity = 1,
                MaxQuantity = product.StockQuantity
            });
        }
        CalculateTotals();
    }

    private void UpdateQuantity(CartItem item, int change)
    {
        item.Quantity += change;
        if (item.Quantity <= 0)
        {
            _cartItems.Remove(item);
        }
        else if (item.Quantity > item.MaxQuantity)
        {
            item.Quantity = item.MaxQuantity;
        }
        CalculateTotals();
    }

    private void RemoveFromCart(CartItem item)
    {
        _cartItems.Remove(item);
        CalculateTotals();
    }

    private void CalculateTotals()
    {
        _subtotal = _cartItems.Sum(i => i.UnitPrice * i.Quantity);
        _tax = _subtotal * 0.10m;
        _total = _subtotal + _tax;
    }

    private async Task ProcessOrder()
    {
        _isProcessing = true;
        _message = null;

        try
        {
            var items = _cartItems.Select(i => new CreateOrderItemRequest(i.ProductId, i.Quantity)).ToList();
            var request = new CreateOrderRequest(items, _tax, 0, null);
            var order = await OrderService.CreateAsync(request);

            if (order is not null)
            {
                _message = $"{L["OrderCompleted"]} {order.OrderNumber}";
                _isSuccess = true;
                _cartItems.Clear();
                CalculateTotals();
                _products = await ProductService.GetAllAsync();
                _filteredProducts = _selectedCategoryId.HasValue
                    ? _products.Where(p => p.CategoryId == _selectedCategoryId).ToList()
                    : _products;
            }
            else
            {
                _message = L["OrderFailed"];
                _isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            _message = $"{L["Error"]}: {ex.Message}";
            _isSuccess = false;
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= OnLanguageChanged;
    }

    private class CartItem
    {
        public Guid ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public decimal UnitPrice { get; set; }
        public int Quantity { get; set; }
        public int MaxQuantity { get; set; }
    }
}
