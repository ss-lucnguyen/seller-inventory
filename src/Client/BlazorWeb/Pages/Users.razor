@page "/users"
@attribute [Authorize(Roles = "Manager,SystemAdmin")]
@implements IDisposable

<PageTitle>@L["Users"] - SellerInventory</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h4">@L["UserManagement"]</MudText>
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Mail"
                   OnClick="ShowInviteModal">@L["InviteUser"]</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PersonAdd"
                   OnClick="ShowAddModal">@L["AddUser"]</MudButton>
    </MudStack>
</div>

@if (_users == null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
}
else
{
    <MudPaper Elevation="2">
        <MudDataGrid Items="_users" Hover="true" Dense="true" Striped="true">
            <Columns>
                <PropertyColumn Property="x => x.Username" Title="@L["Username"]" />
                <PropertyColumn Property="x => x.Email" Title="@L["Email"]" />
                <PropertyColumn Property="x => x.FullName" Title="@L["FullName"]" />
                <TemplateColumn Title="@L["Role"]">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(context.Item.Role)">
                            @GetLocalizedRole(context.Item.Role)
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="@L["Status"]">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@(context.Item.IsActive ? Color.Success : Color.Error)">
                            @(context.Item.IsActive ? L["UserIsActive"] : L["UserInactive"])
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="@L["Created"]">
                    <CellTemplate>
                        @Lang.FormatDate(context.Item.CreatedAt)
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="@L["Actions"]">
                    <CellTemplate>
                        <MudStack Row Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                OnClick="() => ShowEditModal(context.Item)" Title="@L["Edit"]" />
                            <MudIconButton Icon="@Icons.Material.Filled.LockReset" Size="Size.Small" Color="Color.Warning"
                                OnClick="() => ShowResetPasswordModal(context.Item)" Title="@L["ResetPassword"]" />
                            <MudIconButton Icon="@(context.Item.IsActive ? Icons.Material.Filled.PersonOff : Icons.Material.Filled.PersonAdd)"
                                Size="Size.Small" Color="@(context.Item.IsActive ? Color.Error : Color.Success)"
                                OnClick="() => ToggleActive(context.Item)"
                                Title="@(context.Item.IsActive ? L["Deactivate"] : L["Activate"])" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="UserResponse" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
}

<!-- Add/Edit User Dialog -->
<MudDialog @bind-Visible="_showModal" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_isEditing ? L["Edit"] + " " + L["Users"] : L["AddUser"])</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @if (!_isEditing)
            {
                <MudTextField @bind-Value="_formModel.Username" Label="@L["Username"]" Variant="Variant.Outlined" Required="true" />
            }

            <MudTextField @bind-Value="_formModel.Email" Label="@L["Email"]" InputType="InputType.Email" Variant="Variant.Outlined" Required="true" />

            @if (!_isEditing)
            {
                <MudTextField @bind-Value="_formModel.Password" Label="@L["Password"]" InputType="InputType.Password" Variant="Variant.Outlined" Required="true" />
            }

            <MudTextField @bind-Value="_formModel.FullName" Label="@L["FullName"]" Variant="Variant.Outlined" />

            <MudSelect T="string" @bind-Value="_formModel.Role" Label="@L["Role"]" Variant="Variant.Outlined" Required="true">
                @foreach (var role in _roles)
                {
                    <MudSelectItem Value="@role">@GetLocalizedRole(role)</MudSelectItem>
                }
            </MudSelect>

            @if (_isEditing)
            {
                <MudCheckBox T="bool" @bind-Value="_formModel.IsActive" Label="@L["IsActive"]" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseModal" Color="Color.Default">@L["Cancel"]</MudButton>
        <MudButton OnClick="SaveUser" Variant="Variant.Filled" Color="Color.Primary">@L["Save"]</MudButton>
    </DialogActions>
</MudDialog>

<!-- Reset Password Dialog -->
<MudDialog @bind-Visible="_showResetPasswordModal" Options="_smallDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@L["ResetPassword"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-3">@L["ResetPassword"] <strong>@_selectedUser?.Username</strong></MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_resetPasswordModel.NewPassword" Label="@L["NewPassword"]"
                InputType="InputType.Password" Variant="Variant.Outlined" Required="true" />
            <MudTextField @bind-Value="_resetPasswordModel.ConfirmPassword" Label="@L["ConfirmPassword"]"
                InputType="InputType.Password" Variant="Variant.Outlined" Required="true" />

            @if (_resetPasswordModel.NewPassword != _resetPasswordModel.ConfirmPassword
                && !string.IsNullOrEmpty(_resetPasswordModel.ConfirmPassword))
            {
                <MudAlert Severity="Severity.Error">@L["PasswordMismatch"]</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseResetPasswordModal" Color="Color.Default">@L["Cancel"]</MudButton>
        <MudButton OnClick="ResetPassword" Variant="Variant.Filled" Color="Color.Primary"
            Disabled="@(_resetPasswordModel.NewPassword != _resetPasswordModel.ConfirmPassword || string.IsNullOrEmpty(_resetPasswordModel.NewPassword))">
            @L["ResetPassword"]
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Invite User Dialog -->
<MudDialog @bind-Visible="_showInviteModal" Options="_smallDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@L["InviteUser"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-3" Color="Color.Secondary">@L["InviteUserDescription"]</MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_inviteModel.Email" Label="@L["Email"]"
                InputType="InputType.Email" Variant="Variant.Outlined" Required="true"
                Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" />

            <MudSelect T="string" @bind-Value="_inviteModel.Role" Label="@L["Role"]" Variant="Variant.Outlined" Required="true">
                @foreach (var role in _inviteRoles)
                {
                    <MudSelectItem Value="@role">@GetLocalizedRole(role)</MudSelectItem>
                }
            </MudSelect>
        </MudStack>

        @if (_invitationSent is not null)
        {
            <MudAlert Severity="Severity.Success" Class="mt-4">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2">@L["InvitationSentSuccessfully"]</MudText>
                    <MudText Typo="Typo.caption">@L["ExpiresAt"]: @_invitationSent.ExpiresAt.ToLocalTime().ToString("g")</MudText>
                </MudStack>
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseInviteModal" Color="Color.Default">@L["Close"]</MudButton>
        <MudButton OnClick="SendInvitation" Variant="Variant.Filled" Color="Color.Primary"
            Disabled="@(_isInviting || string.IsNullOrEmpty(_inviteModel.Email))">
            @if (_isInviting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            @L["SendInvitation"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Inject] private IUserService UserService { get; set; } = default!;
    [Inject] private IAuthService AuthService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private ILanguageService Lang { get; set; } = default!;
    [Inject] private ILocalizationService L { get; set; } = default!;

    private IReadOnlyList<UserResponse>? _users;
    private readonly List<string> _roles = new() { "Staff", "Manager" };
    private readonly List<string> _inviteRoles = new() { "Staff", "Manager" };
    private bool _showModal;
    private bool _showResetPasswordModal;
    private bool _showInviteModal;
    private bool _isEditing;
    private bool _isInviting;
    private Guid? _editingId;
    private UserResponse? _selectedUser;
    private UserFormModel _formModel = new();
    private ResetPasswordModel _resetPasswordModel = new();
    private InviteUserModel _inviteModel = new();
    private InvitationResponse? _invitationSent;
    private DialogOptions _dialogOptions = new() { FullWidth = true, MaxWidth = MaxWidth.Small };
    private DialogOptions _smallDialogOptions = new() { FullWidth = true, MaxWidth = MaxWidth.ExtraSmall };

    protected override async Task OnInitializedAsync()
    {
        Lang.OnLanguageChanged += OnLanguageChanged;
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _users = await UserService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private void ShowAddModal()
    {
        _formModel = new UserFormModel { Role = "Staff" };
        _isEditing = false;
        _editingId = null;
        _showModal = true;
    }

    private void ShowEditModal(UserResponse user)
    {
        _formModel = new UserFormModel
        {
            Username = user.Username,
            Email = user.Email,
            FullName = user.FullName,
            Role = user.Role,
            IsActive = user.IsActive
        };
        _isEditing = true;
        _editingId = user.Id;
        _showModal = true;
    }

    private void ShowResetPasswordModal(UserResponse user)
    {
        _selectedUser = user;
        _resetPasswordModel = new ResetPasswordModel();
        _showResetPasswordModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private void CloseResetPasswordModal()
    {
        _showResetPasswordModal = false;
        _selectedUser = null;
    }

    private async Task SaveUser()
    {
        try
        {
            if (_isEditing && _editingId.HasValue)
            {
                var request = new UpdateUserRequest(
                    _formModel.Email,
                    _formModel.FullName,
                    _formModel.Role,
                    _formModel.IsActive
                );
                var result = await UserService.UpdateAsync(_editingId.Value, request);
                if (result is not null)
                {
                    Snackbar.Add(L["SuccessfullySaved"], Severity.Success);
                }
                else
                {
                    Snackbar.Add(L["Error"], Severity.Error);
                }
            }
            else
            {
                var request = new CreateUserRequest(
                    _formModel.Username,
                    _formModel.Email,
                    _formModel.Password,
                    _formModel.FullName,
                    _formModel.Role
                );
                var result = await UserService.CreateAsync(request);
                if (result is not null)
                {
                    Snackbar.Add(L["SuccessfullySaved"], Severity.Success);
                }
                else
                {
                    Snackbar.Add(L["Error"], Severity.Error);
                }
            }

            _showModal = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task ResetPassword()
    {
        if (_selectedUser is null) return;

        try
        {
            var request = new ResetPasswordRequest(_resetPasswordModel.NewPassword);
            var success = await UserService.ResetPasswordAsync(_selectedUser.Id, request);

            if (success)
            {
                Snackbar.Add(L["SuccessfullySaved"], Severity.Success);
            }
            else
            {
                Snackbar.Add(L["Error"], Severity.Error);
            }

            _showResetPasswordModal = false;
            _selectedUser = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private async Task ToggleActive(UserResponse user)
    {
        try
        {
            var success = await UserService.ToggleActiveAsync(user.Id);
            if (success)
            {
                Snackbar.Add(L["SuccessfullySaved"], Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add(L["Error"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
    }

    private void ShowInviteModal()
    {
        _inviteModel = new InviteUserModel { Role = "Staff" };
        _invitationSent = null;
        _showInviteModal = true;
    }

    private void CloseInviteModal()
    {
        _showInviteModal = false;
        _invitationSent = null;
    }

    private async Task SendInvitation()
    {
        if (string.IsNullOrWhiteSpace(_inviteModel.Email))
        {
            Snackbar.Add(L["PleaseInputEmail"], Severity.Warning);
            return;
        }

        _isInviting = true;
        _invitationSent = null;

        try
        {
            var request = new InviteUserRequest(_inviteModel.Email, _inviteModel.Role);
            var result = await AuthService.InviteUserAsync(request);

            if (result is not null)
            {
                _invitationSent = result;
                Snackbar.Add(L["InvitationSentSuccessfully"], Severity.Success);
                _inviteModel = new InviteUserModel { Role = "Staff" };
            }
            else
            {
                Snackbar.Add(L["FailedToSendInvitation"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isInviting = false;
        }
    }

    private Color GetRoleColor(string role) => role switch
    {
        "SystemAdmin" => Color.Error,
        "Manager" => Color.Warning,
        _ => Color.Info
    };

    private string GetLocalizedRole(string role) => role switch
    {
        "SystemAdmin" => L["SystemAdmin"],
        "Manager" => L["Manager"],
        "Staff" => L["Staff"],
        _ => role
    };

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= OnLanguageChanged;
    }

    private class UserFormModel
    {
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = "Staff";
        public bool IsActive { get; set; } = true;
    }

    private class ResetPasswordModel
    {
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private class InviteUserModel
    {
        public string Email { get; set; } = string.Empty;
        public string Role { get; set; } = "Staff";
    }
}
