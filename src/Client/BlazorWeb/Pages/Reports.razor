@page "/reports"
@attribute [Authorize]
@implements IDisposable

<PageTitle>Reports - SellerInventory</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["Reports"]</MudText>

<MudGrid Spacing="3">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.DateRange" Class="mr-2" Style="vertical-align: middle;" />
                @L["SalesSummary"]
            </MudText>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="@L["StartDate"]" @bind-Date="_startDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="@L["EndDate"]" @bind-Date="_endDate" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Assessment"
                               OnClick="LoadSummary" FullWidth="true" Class="mb-1">
                        @L["Generate"]
                    </MudButton>
                </MudItem>
            </MudGrid>

            @if (_summary is not null)
            {
                <MudDivider Class="my-4" />
                <MudGrid Spacing="3">
                    <MudItem xs="6" sm="3">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">@L["TotalOrders"]</MudText>
                            <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@Lang.FormatNumber(_summary.TotalOrders)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">@L["TotalRevenue"]</MudText>
                            <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@Lang.FormatCurrency(_summary.TotalRevenue)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">@L["AverageOrderValue"]</MudText>
                            <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@Lang.FormatCurrency(_summary.AverageOrderValue)</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">@L["ProductsSold"]</MudText>
                            <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@Lang.FormatNumber(_summary.TotalProductsSold)</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Today" Class="mr-2" Style="vertical-align: middle;" />
                @L["DailySales"]
            </MudText>
            <MudDatePicker Label="@L["SelectDate"]" Date="_selectedDate" DateChanged="OnDateChanged" Variant="Variant.Outlined"
                           Style="max-width: 300px;" />

            @if (_dailyReport is not null)
            {
                <MudDivider Class="my-4" />
                <MudGrid Spacing="3">
                    <MudItem xs="12" sm="4">
                        <MudPaper Class="pa-4 d-flex align-center" Elevation="0" Style="background: #f5f5f5;">
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="mr-3">
                                <MudIcon Icon="@Icons.Material.Filled.Receipt" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Orders"]</MudText>
                                <MudText Typo="Typo.h5">@Lang.FormatNumber(_dailyReport.TotalOrders)</MudText>
                            </div>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudPaper Class="pa-4 d-flex align-center" Elevation="0" Style="background: #f5f5f5;">
                            <MudAvatar Color="Color.Success" Variant="Variant.Filled" Class="mr-3">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Revenue"]</MudText>
                                <MudText Typo="Typo.h5">@Lang.FormatCurrency(_dailyReport.TotalRevenue)</MudText>
                            </div>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudPaper Class="pa-4 d-flex align-center" Elevation="0" Style="background: #f5f5f5;">
                            <MudAvatar Color="Color.Info" Variant="Variant.Filled" Class="mr-3">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@L["AverageOrder"]</MudText>
                                <MudText Typo="Typo.h5">@Lang.FormatCurrency(_dailyReport.AverageOrderValue)</MudText>
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                @if (_dailyReport.TopSellingProducts?.Any() == true)
                {
                    <MudText Typo="Typo.subtitle1" Class="mt-6 mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-1" />
                        @L["TopSellingProducts"]
                    </MudText>
                    <MudTable Items="_dailyReport.TopSellingProducts" Hover="true" Striped="true" Dense="true">
                        <HeaderContent>
                            <MudTh>@L["Product"]</MudTh>
                            <MudTh>@L["QuantitySold"]</MudTh>
                            <MudTh>@L["Revenue"]</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="@L["Product"]">@context.ProductName</MudTd>
                            <MudTd DataLabel="@L["QuantitySold"]">
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@Lang.FormatNumber(context.QuantitySold)</MudChip>
                            </MudTd>
                            <MudTd DataLabel="@L["Revenue"]">
                                <MudText Color="Color.Success">@Lang.FormatCurrency(context.Revenue)</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mt-4" Variant="Variant.Text">
                        @L["NoSalesForDate"]
                    </MudAlert>
                }
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Inject] private IReportService ReportService { get; set; } = default!;
    [Inject] private ILanguageService Lang { get; set; } = default!;
    [Inject] private ILocalizationService L { get; set; } = default!;

    private DateTime? _startDate = DateTime.Today.AddDays(-30);
    private DateTime? _endDate = DateTime.Today;
    private DateTime? _selectedDate = DateTime.Today;
    private SalesSummary? _summary;
    private DailySalesReport? _dailyReport;

    protected override async Task OnInitializedAsync()
    {
        Lang.OnLanguageChanged += OnLanguageChanged;
        await LoadDailyReport();
    }

    private async Task LoadSummary()
    {
        if (_startDate.HasValue && _endDate.HasValue)
        {
            _summary = await ReportService.GetSalesSummaryAsync(_startDate.Value, _endDate.Value);
        }
    }

    private async Task OnDateChanged(DateTime? date)
    {
        _selectedDate = date;
        await LoadDailyReport();
    }

    private async Task LoadDailyReport()
    {
        if (_selectedDate.HasValue)
        {
            _dailyReport = await ReportService.GetDailySalesAsync(_selectedDate.Value);
        }
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= OnLanguageChanged;
    }
}
